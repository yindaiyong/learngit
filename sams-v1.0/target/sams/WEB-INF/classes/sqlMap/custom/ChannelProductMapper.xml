<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sams.custom.mapper.ChannelProductMapper" >
  <resultMap id="BaseResultMap" type="com.sams.custom.model.ChannelProduct" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 17 16:39:19 CST 2019.
    -->
    <id column="CP_ID" property="cpId" jdbcType="DECIMAL" />
    <result column="CP_CHANNEL_CODE" property="cpChannelCode" jdbcType="VARCHAR" />
    <result column="CP_CHANNEL_PRODUCT_CODE" property="cpChannelProductCode" jdbcType="VARCHAR" />
    <result column="CP_TA_PRODUCT_CODE" property="cpTaProductCode" jdbcType="VARCHAR" />
    <result column="CP_TA_PRODUCT_NAME" property="cpTaProductName" jdbcType="VARCHAR" />
    <result column="CP_CHECK_STATE" property="cpCheckState" jdbcType="VARCHAR" />
    <result column="CP_CTIME" property="cpCtime" jdbcType="TIMESTAMP" />
    <result column="CP_UTIME" property="cpUtime" jdbcType="TIMESTAMP" />
    <result column="CP_CUSER" property="cpCuser" jdbcType="VARCHAR" />
    <result column="CP_UUSER" property="cpUuser" jdbcType="VARCHAR" />
    <result column="CP_ACTION" property="cpAction" jdbcType="VARCHAR" />
    <result column="CP_VALID_FLAG" property="cpValidFlag" jdbcType="VARCHAR" />
    <result column="CP_IS_SETUP" property="cpIsSetUp" jdbcType="VARCHAR" />
    <result column="CP_BATCH_NO" property="cpBatchNumber" jdbcType="VARCHAR" />
  </resultMap>
   
  <sql id="Base_Column_List" >
    CP_ID, CP_CHANNEL_CODE, CP_CHANNEL_PRODUCT_CODE, CP_TA_PRODUCT_CODE, CP_TA_PRODUCT_NAME, CP_CHECK_STATE, 
    CP_CTIME, CP_UTIME, CP_CUSER, CP_UUSER,CP_ACTION,CP_VALID_FLAG,CP_IS_SETUP,CP_BATCH_NO
  </sql>
  
  <resultMap id="channelProductMap" type="com.sams.custom.model.result.ChannelProductInfo" extends="BaseResultMap">
       <result column="ci_channel_name" property="ciChannelName" jdbcType="VARCHAR"/>
       <result column="pi_channel_product_name" property="piChannelProductName"  jdbcType="VARCHAR"/>
       <result column="pi_channel_product_code" property="piChannelProductCode"  jdbcType="VARCHAR"/>
  </resultMap>
  
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 17 16:39:19 CST 2019.
    -->
    delete from P_CHANNEL_PRODUCT
    where CP_ID = #{cpId,jdbcType=DECIMAL}
  </delete>
  <insert id="insert" parameterType="com.sams.custom.model.ChannelProduct" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 17 16:39:19 CST 2019.
    -->
    insert into P_CHANNEL_PRODUCT (CP_ID, CP_CHANNEL_CODE, CP_CHANNEL_PRODUCT_CODE, 
      CP_TA_PRODUCT_CODE, CP_TA_PRODUCT_NAME, CP_CHECK_STATE, 
      CP_CTIME, CP_UTIME, CP_CUSER, 
      CP_UUSER,CP_ACTION,CP_VALID_FLAG,CP_IS_SETUP,cp_batch_no)
    values (#{cpId,jdbcType=DECIMAL}, #{cpChannelCode,jdbcType=VARCHAR}, #{cpChannelProductCode,jdbcType=VARCHAR}, 
      #{cpTaProductCode,jdbcType=VARCHAR}, #{cpTaProductName,jdbcType=VARCHAR}, #{cpCheckState,jdbcType=VARCHAR}, 
      #{cpCtime,jdbcType=TIMESTAMP}, #{cpUtime,jdbcType=TIMESTAMP}, #{cpCuser,jdbcType=VARCHAR}, 
      #{cpUuser,jdbcType=VARCHAR},#{cpAction,jdbcType=VARCHAR},#{cpValidFlag,jdbcType=VARCHAR},#{cpIsSetUp,jdbcType=VARCHAR},#{cpBatchNumber,jdbcType = VARCHAR})
  </insert>

  <update id="updateByPrimaryKey" parameterType="com.sams.custom.model.ChannelProduct" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 17 16:39:19 CST 2019.
    -->
    update P_CHANNEL_PRODUCT
    set CP_CHANNEL_CODE = #{cpChannelCode,jdbcType=VARCHAR},
      CP_CHANNEL_PRODUCT_CODE = #{cpChannelProductCode,jdbcType=VARCHAR},
      CP_TA_PRODUCT_CODE = #{cpTaProductCode,jdbcType=VARCHAR},
      CP_TA_PRODUCT_NAME = #{cpTaProductName,jdbcType=VARCHAR},
      CP_CHECK_STATE = #{cpCheckState,jdbcType=VARCHAR},
      CP_CTIME = #{cpCtime,jdbcType=TIMESTAMP},
      CP_UTIME = #{cpUtime,jdbcType=TIMESTAMP},
      CP_CUSER = #{cpCuser,jdbcType=VARCHAR},
      CP_UUSER = #{cpUuser,jdbcType=VARCHAR},
      CP_ACTION = #{cpAction,jdbcType=VARCHAR},
      CP_VALID_FLAG = #{cpValidFlag,jdbcType=VARCHAR},
      CP_IS_SETUP = #{cpIsSetUp,jdbcType=VARCHAR},
      CP_BATCH_NO = #{cpBatchNumber,jdbcType=VARCHAR}
    where CP_ID = #{cpId,jdbcType=DECIMAL}
  </update>
   
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 17 16:39:19 CST 2019.
    -->
    select CP_ID, CP_CHANNEL_CODE, CP_CHANNEL_PRODUCT_CODE, CP_TA_PRODUCT_CODE, CP_TA_PRODUCT_NAME, 
    CP_CHECK_STATE, CP_CTIME, CP_UTIME, CP_CUSER, CP_UUSER,CP_ACTION,CP_VALID_FLAG,CP_IS_SETUP,CP_BATCH_NO
    from P_CHANNEL_PRODUCT
    where CP_ID = #{cpId,jdbcType=DECIMAL}
  </select>
  
  <select id="selectAll" resultMap="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 17 16:39:19 CST 2019.
    -->
    select CP_ID, CP_CHANNEL_CODE, CP_CHANNEL_PRODUCT_CODE, CP_TA_PRODUCT_CODE, CP_TA_PRODUCT_NAME, 
    CP_CHECK_STATE, CP_CTIME, CP_UTIME, CP_CUSER, CP_UUSER,CP_ACTION,CP_VALID_FLAG,CP_IS_SETUP,CP_BATCH_NO
    from P_CHANNEL_PRODUCT
  </select>

    <sql id="getDataToOrder">
        CP_ID cpId,
    CP_CHANNEL_CODE cpChannelCode,
    CP_CHANNEL_PRODUCT_CODE cpChannelProductCode,
    CP_TA_PRODUCT_CODE cpTaProductCode,
    CP_TA_PRODUCT_NAME cpTaProductName,
    CP_CHECK_STATE cpCheckState,
    CP_CTIME cpCtime,
    CP_UTIME cpUtime,
    CP_CUSER cpCuser,
    CP_UUSER cpUuser,
    CP_ACTION cpAction,
    CP_VALID_FLAG cpValidFlag,
    CP_IS_SETUP cpIsSetUp,
    CP_BATCH_NO cpBatchNumber,
    ci_channel_name ciChannelName,
    pi_channel_product_name piChannelProductName,
    pi_channel_product_code piChannelProductCode
    </sql>
    <select id="findChannelProductCondition" parameterType="java.util.Map"  resultMap="channelProductMap">
       select <include refid="getDataToOrder"/> from(select
        <include refid="Base_Column_List"/>
        , b.ci_channel_name, c.pi_channel_product_name,c.pi_channel_product_code
        from p_channel_product a
    left join p_channel_info b
      on a.CP_CHANNEL_CODE = b.ci_channel_code
    left join p_product_info c
      on a.CP_CHANNEL_PRODUCT_CODE = c.pi_channel_product_code
         and a.CP_BATCH_NO = c.PI_BATCH_NO
         and a.CP_CHANNEL_CODE = c.PI_CHANNEL_CODE
        where c.pi_valid_flag not in('99','00')
         and c.pi_check_state='01'
        and b.ci_valid_flag = '01'
        and b.ci_check_state = '01')d where (d.cp_valid_flag !='00' or d.cp_check_state !='01')
        <if test=" condition.ciChannelCode != null and condition.ciChannelCode != ''  ">
                and d.cp_channel_code = #{condition.ciChannelCode}
        </if>
        <if test=" condition.piChannelProductCode != null and condition.piChannelProductCode != ''  ">
                and d.pi_channel_product_code = #{condition.piChannelProductCode} 
        </if>
        <if test=" condition.cpCheckState != null and condition.cpCheckState != '' ">
                and d.CP_CHECK_STATE = #{condition.cpCheckState} 
        </if>
         <if test=" condition.piBatchNumber != null and condition.piBatchNumber != '' ">
                and d.CP_BATCH_NO = #{condition.piBatchNumber} 
        </if>
        <if test="pageInfo.sort != null and pageInfo.sort != ''">
            order by ${pageInfo.sort} ${pageInfo.order}
        </if>
    </select>
    
    <select id="selectChannelProductInfo" parameterType="String"  resultMap="channelProductMap">
       select * from(select
        <include refid="Base_Column_List"/>
        , b.ci_channel_name, c.pi_channel_product_name
        from p_channel_product a
          ,p_channel_info b,p_product_info c
           where CP_ID = #{cpId,jdbcType=DECIMAL} 
            and  a.CP_CHANNEL_CODE = b.ci_channel_code
            and  a.CP_CHANNEL_PRODUCT_CODE = c.pi_channel_product_code
            and  a.CP_CHANNEL_CODE = c.pi_channel_code
            and  a.cp_batch_no = c.pi_batch_no
            and b.ci_valid_flag = '01' and b.ci_check_state = '01'
            and c.pi_valid_flag not in('00','99')
            and c.pi_check_state='01'
            and b.ci_valid_flag='01'
            and b.ci_check_state='01'
        )
    </select>
    
    
     <select id="selectProductByChannel" parameterType="com.sams.custom.model.ChannelProduct"  resultMap="BaseResultMap">
         select
        <include refid="Base_Column_List"/>
         FROM p_channel_product 
              where  cp_channel_code = #{CHANNELCODE,jdbcType=VARCHAR}
                and  cp_channel_product_code = #{FUNDCODE,jdbcType=VARCHAR}
                and  cp_check_state ='01'
                and  cp_valid_flag='01'
     </select>
     
     <select id="selectChannelProductCount" parameterType="String"  resultType="int">
        select count(*) from p_channel_product where cp_channel_code = #{channelCode,jdbcType=VARCHAR} and cp_valid_flag = '01'
     </select>
     
     <select id="selectProductCount" parameterType="String"  resultType="int">
        select count(*) from p_channel_product,p_product_info where cp_channel_code = #{channelCode,jdbcType=VARCHAR} and cp_channel_product_code=pi_channel_product_code and pi_valid_flag!='00' and cp_valid_flag = '01'
     </select>
     
     <select id="selectChannelProduct" parameterType="Map"  resultType="com.sams.custom.model.ChannelProduct">
        select * from p_channel_product where CP_CHANNEL_PRODUCT_CODE = #{FUNDCODE,jdbcType=VARCHAR} and CP_TA_PRODUCT_CODE=#{TAFUNDCODE,jdbcType=VARCHAR} and CP_CHANNEL_CODE = #{CHANNELCODE,jdbcType = VARCHAR} and cp_batch_no = #{BATCHNUMBER,jdbcType = VARCHAR} and CP_VALID_FLAG!='00'
     </select>
     
    <update id="updateChannelProduct" parameterType="java.util.List" >
    
      <foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
  		   update  P_CHANNEL_PRODUCT set CP_VALID_FLAG='00',CP_CHECK_STATE='01',CP_ACTION='00',CP_CUSER='sams',CP_CTIME=(select sysdate from dual)
  		   where CP_CHANNEL_CODE=#{item.CHANNELCODE,jdbcType=VARCHAR} AND CP_CHANNEL_PRODUCT_CODE=#{item.FUNDCODE,jdbcType=VARCHAR}
	  </foreach>
 </update>

  <select id="selectCodeByName" resultMap="BaseResultMap">
      select * from p_channel_product where cp_ta_product_name = #{productName} and rownum=1
  </select>
     
</mapper>