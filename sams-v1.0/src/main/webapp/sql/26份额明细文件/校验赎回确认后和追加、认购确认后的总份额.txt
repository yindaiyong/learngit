--校验赎回确认后和追加/认购确认后的总份额 该渠道，该产品，该客户的上一日总份额的和-赎回确认份额+122/130确认份额= 今日可用份额的和
select count(1)
  from (select tt.totalVol - ttt.totalVol countflag
          from (select nvl(t1.totalVol, 0) - nvl(t2.confirmedvol, 0) + nvl(t3.confirmedvol, 0) + nvl(t4.confirmedvol, 0) totalVol,
                       t1.fvd_channel_code,
                       t1.fvd_fund_code,
                       t1.fvd_transaction_account_id
                  from (select sum(t.fvd_total_vol_of_distributor) totalVol,
                               t.fvd_channel_code,
                               t.fvd_fund_code,
                               t.fvd_transaction_account_id
                          from d_fund_vol_detail_cfm t
                         where t.fvd_channel_code = 'TTTNETB3'--CHANNELCODE
                           and t.fvd_trans_date = '20200522'--LASTDATE
                         group by t.fvd_channel_code,
                                  t.fvd_fund_code,
                                  t.fvd_transaction_account_id) t1
                                  
                  left join (select sum(e.erc_confirmed_vol) confirmedvol,
                       e.erc_channel_code,
                       e.erc_fund_code,
                       e.erc_transaction_account_id
                  from d_exchange_req_cfm e
                 where e.erc_channel_code = 'TTTNETB3'--CHANNELCODE
                   and e.erc_trans_date = '20200525'--TRANSDATE
                   and e.erc_business_code = '024'
                   and e.erc_return_code = '0000'
                 group by e.erc_channel_code,
                          e.erc_fund_code,
                          e.erc_transaction_account_id) t2
                    on t1.fvd_channel_code = t2.erc_channel_code
                   and t1.fvd_fund_code = t2.erc_fund_code
                   and t1.fvd_transaction_account_id =
                       t2.erc_transaction_account_id
                       
                  left join (select sum(e.erc_confirmed_vol) confirmedvol,
                       e.erc_channel_code,
                       e.erc_fund_code,
                       e.erc_transaction_account_id
                  from d_exchange_req_cfm e
                 where e.erc_channel_code = 'TTTNETB3'--CHANNELCODE
                   and e.erc_trans_date = '20200525'--TRANSDATE
                   and e.erc_business_code = '130'
                   and e.erc_return_code = '0000'
                 group by e.erc_channel_code,
                          e.erc_fund_code,
                          e.erc_transaction_account_id) t3
                   on t1.fvd_channel_code = t3.erc_channel_code
                   and t1.fvd_fund_code = t3.erc_fund_code
                   and t1.fvd_transaction_account_id =
                       t3.erc_transaction_account_id 
                            
                    left join (select sum(e.erc_confirmed_vol) confirmedvol,
                       e.erc_channel_code,
                       e.erc_fund_code,
                       e.erc_transaction_account_id
                  from d_exchange_req_cfm e
                 where e.erc_channel_code = 'TTTNETB3'--CHANNELCODE
                   and e.erc_trans_date = '20200525'--TRANSDATE
                   and e.erc_business_code = '022'
                   and e.erc_return_code = '0000'
                 group by e.erc_channel_code,
                          e.erc_fund_code,
                          e.erc_transaction_account_id)t4 
                   on t1.fvd_channel_code = t4.erc_channel_code
                   and t1.fvd_fund_code = t4.erc_fund_code
                   and t1.fvd_transaction_account_id =
                       t4.erc_transaction_account_id 
                    ) tt ,
                    
               (select sum(t.fvd_total_vol_of_distributor) totalVol,
                                   t.fvd_channel_code,
                                   t.fvd_fund_code,
                                   t.fvd_transaction_account_id
                              from d_fund_vol_detail_cfm t
                             where t.fvd_channel_code = 'TTTNETB3'--CHANNELCODE
                               and t.fvd_trans_date = '20200525'--TRANSDATE
                             group by t.fvd_channel_code,
                                      t.fvd_fund_code,
                                      t.fvd_transaction_account_id) ttt
         where ttt.fvd_channel_code = tt.fvd_channel_code
           and ttt.fvd_fund_code = tt.fvd_fund_code
           and ttt.fvd_transaction_account_id = tt.fvd_transaction_account_id) pp
 where pp.countflag != 0
