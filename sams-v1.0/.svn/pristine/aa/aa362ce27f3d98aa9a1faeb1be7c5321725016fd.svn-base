<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sams.custom.mapper.ProductOpenDayMapper">
  <resultMap id="BaseResultMap" type="com.sams.custom.model.ProductOpenDay">
    <result column="PO_ID" jdbcType="VARCHAR" property="poId" />
    <result column="PO_CHANNEL_CODE" jdbcType="VARCHAR" property="poChannelCode" />
    <result column="PO_PRODUCT_CODE" jdbcType="VARCHAR" property="poProductCode" />
    <result column="PO_YEAR" jdbcType="VARCHAR" property="poYear" />
    <result column="PO_MONTH" jdbcType="VARCHAR" property="poMonth" />
    <result column="PO_CLOSE_DAY" jdbcType="VARCHAR" property="poCloseDay" />
    <result column="PO_BATCH_NO" jdbcType="VARCHAR" property="poBatchNo" />
    <result column="PO_CTIME" jdbcType="TIMESTAMP" property="poCtime" />
    <result column="PO_UTIME" jdbcType="TIMESTAMP" property="poUtime" />
    <result column="PO_CUSER" jdbcType="VARCHAR" property="poCuser" />
    <result column="PO_UUSER" jdbcType="VARCHAR" property="poUuser" />
    <result column="PO_ACTION" jdbcType="VARCHAR" property="poAction" />
    <result column="PO_CHECK_STATE" jdbcType="VARCHAR" property="poCheckState" />
    <result column="PO_OPEN_DAY_TYPE" jdbcType="VARCHAR" property="poOpenDayType" />
  </resultMap>
  
  <sql id="Base_Column_List" >
      PO_ID, PO_CHANNEL_CODE, PO_PRODUCT_CODE, 
      PO_YEAR, PO_MONTH, PO_CLOSE_DAY, 
      PO_BATCH_NO, PO_CTIME, PO_UTIME, 
      PO_CUSER, PO_UUSER, PO_ACTION,PO_CHECK_STATE,PO_OPEN_DAY_TYPE
  </sql>
  
  <insert id="insert" parameterType="com.sams.custom.model.ProductOpenDay">
    insert into P_PRODUCT_OPEN_DAY (PO_ID, PO_CHANNEL_CODE, PO_PRODUCT_CODE, 
      PO_YEAR, PO_MONTH, PO_CLOSE_DAY, 
      PO_BATCH_NO, PO_CTIME, PO_UTIME, 
      PO_CUSER, PO_UUSER, PO_ACTION,
      PO_CHECK_STATE,PO_OPEN_DAY_TYPE
      )
    values (#{poId,jdbcType=VARCHAR}, #{poChannelCode,jdbcType=VARCHAR}, #{poProductCode,jdbcType=VARCHAR}, 
      #{poYear,jdbcType=VARCHAR}, #{poMonth,jdbcType=VARCHAR}, #{poCloseDay,jdbcType=VARCHAR}, 
      #{poBatchNo,jdbcType=VARCHAR}, #{poCtime,jdbcType=TIMESTAMP}, #{poUtime,jdbcType=TIMESTAMP}, 
      #{poCuser,jdbcType=VARCHAR}, #{poUuser,jdbcType=VARCHAR}, #{poAction,jdbcType=VARCHAR}, 
      #{poCheckState,jdbcType=VARCHAR},#{poOpenDayType,jdbcType=VARCHAR}
      )
  </insert>
  
  <insert id="insertSelective" parameterType="com.sams.custom.model.ProductOpenDay">
    insert into P_PRODUCT_OPEN_DAY
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="poId != null">
        PO_ID,
      </if>
      <if test="poChannelCode != null">
        PO_CHANNEL_CODE,
      </if>
      <if test="poProductCode != null">
        PO_PRODUCT_CODE,
      </if>
      <if test="poYear != null">
        PO_YEAR,
      </if>
      <if test="poMonth != null">
        PO_MONTH,
      </if>
      <if test="poCloseDay != null">
        PO_CLOSE_DAY,
      </if>
      <if test="poBatchNo != null">
        PO_BATCH_NO,
      </if>
      <if test="poCtime != null">
        PO_CTIME,
      </if>
      <if test="poUtime != null">
        PO_UTIME,
      </if>
      <if test="poCuser != null">
        PO_CUSER,
      </if>
      <if test="poUuser != null">
        PO_UUSER,
      </if>
      <if test="poAction != null">
        PO_ACTION,
      </if>
       <if test="poCheckState != null">
        PO_CHECK_STATE,
      </if>
      <if test="poOpenDayType != null">
        PO_OPEN_DAY_TYPE,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="poId != null">
        #{poId,jdbcType=VARCHAR},
      </if>
      <if test="poChannelCode != null">
        #{poChannelCode,jdbcType=VARCHAR},
      </if>
      <if test="poProductCode != null">
        #{poProductCode,jdbcType=VARCHAR},
      </if>
      <if test="poYear != null">
        #{poYear,jdbcType=VARCHAR},
      </if>
      <if test="poMonth != null">
        #{poMonth,jdbcType=VARCHAR},
      </if>
      <if test="poCloseDay != null">
        #{poCloseDay,jdbcType=VARCHAR},
      </if>
      <if test="poBatchNo != null">
        #{poBatchNo,jdbcType=VARCHAR},
      </if>
      <if test="poCtime != null">
        #{poCtime,jdbcType=TIMESTAMP},
      </if>
      <if test="poUtime != null">
        #{poUtime,jdbcType=TIMESTAMP},
      </if>
      <if test="poCuser != null">
        #{poCuser,jdbcType=VARCHAR},
      </if>
      <if test="poUuser != null">
        #{poUuser,jdbcType=VARCHAR},
      </if>
      <if test="poAction != null">
        #{poAction,jdbcType=VARCHAR},
      </if>
      <if test="poCheckState != null">
        #{poCheckState,jdbcType=VARCHAR},
      </if>
      <if test="poOpenDayType != null">
        #{poOpenDayType,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  
  <select id="findDataGrid" parameterType="java.util.Map"  resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        FROM p_product_open_day where 1=1
        <if test=" condition.channelCode != null and condition.channelCode != ''  ">
                and PO_CHANNEL_CODE =  #{condition.channelCode} 
        </if>
        <if test=" condition.productCode != null and condition.productCode != ''  ">
                and PO_PRODUCT_CODE =  #{condition.productCode} 
        </if>
        <if test=" condition.batchNo != null and condition.batchNo != ''  ">
                and PO_BATCH_NO =  #{condition.batchNo} 
        </if>
        <if test=" condition.year != null and condition.year != '' ">
                and PO_YEAR = #{condition.year} 
        </if>
        <if test=" condition.month != null and condition.month != '' ">
                and PO_MONTH = #{condition.month} 
        </if>
        <if test=" condition.checkState != null and condition.checkState != '' ">
                and PO_CHECK_STATE = #{condition.checkState} 
        </if>
              and PO_OPEN_DAY_TYPE = #{condition.opType}
         <if test="pageInfo.sort != null and pageInfo.sort != ''">
            order by ${pageInfo.sort} ${pageInfo.order}
        </if>
    </select>
    
      <select id="qryProOpenDayList" parameterType="java.util.Map"  resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        FROM p_product_open_day where 1=1
        <if test="channelCode != null and channelCode != ''  ">
                and PO_CHANNEL_CODE =  #{channelCode} 
        </if>
        <if test="productCode != null and productCode != ''  ">
                and PO_PRODUCT_CODE =  #{productCode} 
        </if>
        <if test="batchNo != null and batchNo != ''  ">
                and PO_BATCH_NO =  #{batchNo} 
        </if>
        <if test="year != null and year != '' ">
                and PO_YEAR = #{year} 
        </if>
        <if test="month != null and month != '' ">
                and PO_MONTH = #{month} 
        </if>
        <if test="tradeDate != null and tradeDate != '' ">
                and PO_CLOSE_DAY = #{tradeDate} 
        </if>
        <if test="checkState != null and checkState != '' ">
                and PO_CHECK_STATE = #{checkState} 
        </if>
        <if test="openDayType != null and openDayType != '' ">
                and PO_OPEN_DAY_TYPE = #{openDayType} 
        </if>
    </select>
    
    <delete id="deleteProOpenDay" parameterType="hashMap" >
    delete from p_product_open_day where 1=1
    <if test="channelCode != null and channelCode != ''  ">
            and PO_CHANNEL_CODE =  #{channelCode} 
    </if>
    <if test="productCode != null and productCode != ''  ">
            and PO_PRODUCT_CODE =  #{productCode} 
    </if>
    <if test="batchNo != null and batchNo != ''  ">
            and PO_BATCH_NO =  #{batchNo} 
    </if>
    <if test="year != null and year != '' ">
            and PO_YEAR = #{year} 
    </if>
    <if test="month != null and month != '' ">
            and PO_MONTH = #{month} 
    </if>
            and PO_OPEN_DAY_TYPE = #{opType}
   </delete>
   
   <update id="updateAllProOpenDay" parameterType="java.util.List">
      <foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
    update P_PRODUCT_OPEN_DAY
    set 
      PO_CHECK_STATE = #{item.poCheckState,jdbcType=VARCHAR},
      PO_UTIME = #{item.poUtime,jdbcType=TIMESTAMP},
      PO_UUSER = #{item.poUuser,jdbcType=VARCHAR},
      PO_ACTION = #{item.poAction,jdbcType=VARCHAR}
    where 
            PO_CHANNEL_CODE =  #{item.poChannelCode} 
      and   PO_PRODUCT_CODE =  #{item.poProductCode} 
      and   PO_BATCH_NO =  #{item.poBatchNo} 
      and   PO_YEAR = #{item.poYear} 
      and   PO_MONTH = #{item.poMonth} 
    </foreach>
  </update>
    <!--查询当前选择的渠道产品年份是否有非工作日配置-->
    <select id="selectOpenDayMonList" resultMap="BaseResultMap" parameterType="hashmap">
      select t1.*
          from p_product_open_day t1,
               (select po_month p_month, max(po_close_day) p_close_day
                  from p_product_open_day
                 where 1 = 1
                   AND PO_YEAR = #{YEAR,jdbcType=VARCHAR}
                   <if test="CHANNELCODE != null">
                       AND PO_CHANNEL_CODE = #{CHANNELCODE,jdbcType=VARCHAR}
                   </if>
                    <if test="PRODUCTCODE != null">
                        and po_product_code = #{PRODUCTCODE,jdbcType=VARCHAR}
                    </if>
                    <if test="BATCHNO != null">
                        and PO_BATCH_NO = #{BATCHNO,jdbcType=VARCHAR}
                    </if>
                        and PO_OPEN_DAY_TYPE = #{OPTYPE,jdbcType=VARCHAR}
                 group by PO_month) t2
         where t1.PO_close_day = t2.p_close_day
           and t1.po_month = t2.p_month
           AND t1.PO_YEAR = #{YEAR,jdbcType=VARCHAR}
            and t1.PO_OPEN_DAY_TYPE = #{OPTYPE,jdbcType=VARCHAR}
            <if test="CHANNELCODE != null">
                AND t1.PO_CHANNEL_CODE = #{CHANNELCODE,jdbcType=VARCHAR}
            </if>
            <if test="PRODUCTCODE != null">
                and t1.po_product_code = #{PRODUCTCODE,jdbcType=VARCHAR}
            </if>
            <if test="BATCHNO != null">
                and t1.PO_BATCH_NO = #{BATCHNO,jdbcType=VARCHAR}
            </if>

    </select>
    <update id="updateStatusByMonthIndex" parameterType="hashmap">
        update p_product_open_day
        <set>
            <if test="userName != null">
                PO_UUSER = #{userName,jdbcType=VARCHAR},
            </if>
            <if test="action != null">
                PO_ACTION = #{action,jdbcType=VARCHAR},
            </if>
            <if test="checkStatus != null">
                PO_CHECK_STATE = #{checkStatus,jdbcType=VARCHAR},
            </if>
        </set>
        where
        <choose>
            <when test="channelCode != null and productCode != null and mon != null">
                1 = 1
            </when>
            <otherwise>
                1 != 1
            </otherwise>
        </choose>
        <if test=" channelCode != null ">
            and PO_CHANNEL_CODE =  #{channelCode,jdbcType=VARCHAR}
        </if>
        <if test=" productCode != null ">
            and PO_PRODUCT_CODE =  #{productCode,jdbcType=VARCHAR}
        </if>
        <if test="yearVal != null">
            AND  PO_YEAR=#{yearVal,jdbcType=VARCHAR}
        </if>
        <if test="mon != null">
            AND  PO_month=#{mon,jdbcType=VARCHAR}
        </if>
        <if test="batchNo != null">
            and PO_BATCH_NO = #{batchNo,jdbcType=VARCHAR}
        </if>
            and PO_OPEN_DAY_TYPE = #{opType,jdbcType=VARCHAR}
    </update>
    <!--批量插入sql-->
    <insert id="insertByBatch" parameterType="com.sams.custom.model.ProductOpenDay">
        insert
        <foreach collection="list" index="index" item="item" open="All" close="SELECT 1 FROM DUAL">
            into P_PRODUCT_OPEN_DAY (PO_ID, PO_CHANNEL_CODE, PO_PRODUCT_CODE,
            PO_YEAR, PO_MONTH, PO_CLOSE_DAY,
            PO_BATCH_NO, PO_CTIME, PO_UTIME,
            PO_CUSER, PO_UUSER, PO_ACTION,
            PO_CHECK_STATE,PO_OPEN_DAY_TYPE
            )
            values (#{item.poId,jdbcType=VARCHAR}, #{item.poChannelCode,jdbcType=VARCHAR}, #{item.poProductCode,jdbcType=VARCHAR},
            #{item.poYear,jdbcType=VARCHAR}, #{item.poMonth,jdbcType=VARCHAR}, #{item.poCloseDay,jdbcType=VARCHAR},
            #{item.poBatchNo,jdbcType=VARCHAR}, #{item.poCtime,jdbcType=TIMESTAMP}, #{item.poUtime,jdbcType=TIMESTAMP},
            #{item.poCuser,jdbcType=VARCHAR}, #{item.poUuser,jdbcType=VARCHAR}, #{item.poAction,jdbcType=VARCHAR}, 
            #{item.poCheckState,jdbcType=VARCHAR},#{item.poOpenDayType,jdbcType=VARCHAR}
            )
        </foreach>
    </insert>
    
    <delete id="deleteCloseDateByDate" parameterType="com.sams.custom.model.ProductOpenDay">
        delete from P_PRODUCT_OPEN_DAY
        where
        <choose>
            <when test="poChannelCode != null and poProductCode != null and poCloseDay != null">
                1 = 1
            </when>
            <otherwise>
                1 != 1
            </otherwise>
        </choose>
        and PO_CHANNEL_CODE = #{poChannelCode,jdbcType=VARCHAR}
        and PO_PRODUCT_CODE = #{poProductCode,jdbcType=VARCHAR}
        and PO_YEAR = #{poYear,jdbcType=VARCHAR}
        and PO_MONTH = #{poMonth,jdbcType=VARCHAR}
        and PO_CLOSE_DAY = #{poCloseDay,jdbcType=VARCHAR}
        and PO_BATCH_NO = #{poBatchNo,jdbcType=VARCHAR}
        and PO_OPEN_DAY_TYPE = #{poOpenDayType,jdbcType=VARCHAR}
    </delete>
    
    <select id="queryIsOpenDay" parameterType="map" resultType="int">
    	select count(1) from P_PRODUCT_OPEN_DAY t  
		where t.po_channel_code = #{CHANNELCODE,jdbcType = VARCHAR}
		and t.po_product_code = #{FUNDCODE,jdbcType = VARCHAR}
		and t.po_open_day_type = #{BUSINESSCODE,jdbcType = VARCHAR}
		and t.po_close_day = #{TRANSDATE,jdbcType = VARCHAR}
    </select>
</mapper>