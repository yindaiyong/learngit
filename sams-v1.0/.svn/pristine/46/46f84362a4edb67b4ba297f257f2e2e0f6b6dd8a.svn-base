select aa.*, bb.sumRemainshares
  from (select *
          from (select t.*,
                       row_number() over(partition by pi_channel_product_code order by pi_id desc) rownumber
                  from (select *
                          from (select *
                                  from p_channel_info t,
                                       (select *
                                          from (select t.*,
                                                       row_number() over(partition by cp_channel_product_code order by cp_id desc) row_number
                                                  from (select *
                                                          from p_channel_product
                                                         where cp_valid_flag = '01'
                                                           and cp_check_state = '01'
                                                           and cp_channel_code = 'TTTNETSWHY') t) t1
                                         where row_number = 1) p
                                 where t.ci_channel_code = p.cp_channel_code
                                   and t.ci_check_state = '01'
                                   and t.ci_valid_flag = '01'
                                   and t.ci_channel_code = 'TTTNETSWHY'
                                   and p.cp_channel_code = 'TTTNETSWHY'
                                   and p.cp_check_state = '01'
                                   and p.cp_valid_flag = '01') t1,
                               p_product_info i
                         where t1.cp_channel_product_code =
                               i.pi_channel_product_code
                           and t1.cp_channel_code = i.pi_channel_code
                           and t1.cp_batch_no = i.pi_batch_no
                           and i.pi_check_state = '01'
                           and i.PI_VALID_FLAG != '00'
                           and i.PI_VALID_FLAG != '99') t) t1
         where rownumber = 1
           and to_date(pi_ipo_begin_date, 'yyyyMMdd') <=
               to_date('20190903', 'yyyyMMdd')
           and (to_date(nvl(pi_pro_end_date, '99991231'), 'yyyyMMdd')) >=
               to_date('20190923', 'yyyyMMdd') -
               (SELECT nvl(dict_code, '0') dict_code
                  FROM sys_dict
                 where dict_type = 'fundSendEndDate')) aa,
       (select kk.pi_channel_product_code, sum(remainshares) sumRemainshares
          from (select ii.*, dd.remainshares
                  from (select *
                          from (select *
                                  from p_channel_info t,
                                       (select *
                                          from p_channel_product
                                         where cp_valid_flag = '01'
                                           and cp_check_state = '01'
                                           and cp_channel_code = 'TTTNETSWHY') p
                                 where t.ci_channel_code = p.cp_channel_code
                                   and t.ci_check_state = '01'
                                   and t.ci_valid_flag = '01'
                                   and p.cp_check_state = '01'
                                   and p.cp_valid_flag = '01') t1,
                               p_product_info i
                         where t1.cp_channel_product_code =
                               i.pi_channel_product_code
                           and t1.cp_channel_code = i.pi_channel_code
                           and t1.cp_batch_no = i.pi_batch_no
                           and i.pi_check_state = '01'
                           and i.PI_VALID_FLAG != '00'
                           and i.PI_VALID_FLAG != '99'
                           and to_date(pi_ipo_begin_date, 'yyyyMMdd') <=
                               to_date('20190903', 'yyyyMMdd')
                           and (to_date(nvl(pi_pro_end_date, '99991231'),
                                        'yyyyMMdd')) >=
                               to_date('20190903', 'yyyyMMdd') -
                               (SELECT nvl(dict_code, '0') dict_code
                                  FROM sys_dict
                                 where dict_type = 'fundSendEndDate')) ii
                  left join (select sum(ts.f_remainshares) remainshares,
                                   ts.c_fundcode
                              from ta_ttrustcontractdetails tt,
                                   ta_tsharedetail          ts
                             where tt.l_serialno = ts.l_contractserialno
                               and tt.c_trustagencyno = 'TTTNETSWHY'
                             group by ts.c_fundcode) dd
                    on ii.cp_ta_product_code = dd.c_fundcode) kk
         group by kk.pi_channel_product_code) bb
 where aa.pi_channel_product_code = bb.pi_channel_product_code
