<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ include file="/WEB-INF/views/include/common.jsp"%>
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<head>
<title>反洗钱非居民信息页面</title>
</head>
<script type="text/javascript">
    $(function(){
        $("#uploadFile1").click(function () {
            var file = $("#file1").filebox("files")[0];
            var channelCode = $('#channelCode').combobox("getValue");
            var channelName = $('#channelCode').combobox("getText");
            if (file === null || typeof (file) == "undefined") {
                $.messager.alert('提示','请选择要上传的文件','warning');
                return;
            }
            if (channelCode === null || channelCode == "") {
                $.messager.alert('提示','请选择文件所属的渠道','warning');
                return;
            }
            //执行ajax远程文件上传操作
            var fd = new FormData();
            fd.append("file", file);
            fd.append("type", "1");
            fd.append("channelCode", channelCode+"");
            parent.$.messager.confirm("询问", "您确认上传"+"渠道编号《"+channelName+"》" +"个人反洗钱信息文件吗？", function(b) {
                if (b) {
                    uploadFile(fd);
                }
            });
        })
        //机构文件上传
        $("#uploadFile2").click(function () {
            var file = $("#file2").filebox("files")[0];
            var channelCode = $('#channelCode').combobox("getValue");
            var channelName = $('#channelCode').combobox("getText");
            if (file === null || typeof (file) == "undefined") {
                $.messager.alert('提示','请选择要上传的文件','warning');
                return;
            }
            if (channelCode === null || channelCode == ""){
                $.messager.alert('提示','请选择文件所属的渠道','warning');
                return;
            }
            //执行ajax远程文件上传操作
            var fd = new FormData();
            fd.append("file", file);
            fd.append("type", "2");
            fd.append("channelCode", channelCode+"");
            parent.$.messager.confirm("询问", "您确认上传"+"渠道编号《"+channelName+"》" +"机构反洗钱信息文件吗？", function(b) {
                if (b) {
                    uploadFile(fd);
                }
            });

        })

        function uploadFile(fd) {
            $.messager.progress({
                title : '提示',
                text : '正在上传文件，请等待....'
            });
            $.ajax({
                url:"${ctx}/downloadFile/uploadFile",
                type:"post",
                data:fd,
                cache: false,
                processData: false,
                contentType: false,
                success:function(data){
                    console.log(JSON.parse(data))
                    var resMsg = JSON.parse(data).msg
                    if("success" == resMsg){
                        $.messager.progress('close');
                        $.messager.show({
                            title : '提示',
                            msg : "上传保存成功！",
                            timeout : 2000
                        });
                    }else{
                        $.messager.progress('close');
                        $.messager.alert('错误', resMsg,'error');
                    }
                },
                error:function(e){
                    $.messager.alert("错误","服务器异常，请稍后重试！！！<br/>"+e.message,'error');
                }
            });
        };

        //数据展示信息
        dataGrid = $('#dataGrid')
            .datagrid({
                url : '${ctx}/downloadFile/getAgentPaymentData',
                striped : true,
                rownumbers : true,
                pagination : true,
                idField : 'ciId',
                sortName : '',
                pageSize : 10,
                pageList : [ 10, 20, 30, 40, 50, 100, 200, 300,
                    400, 500 ],
                frozenColumns : [ []],
                columns : [[{
                    title : '渠道编号',
                    field : 'aipdChannelCode',
                    width : 90,
                    halign : 'center',
                    align : 'center'
                },{
                    title : '产品名称',
                    field : 'aipdProductName',
                    width : 120,
                    halign : 'center',
                    align : 'center'
                },{
                    title : '数据类型',
                    field : 'aipdType',
                    width : 90,
                    halign : 'center',
                    align : 'center',
                    formatter : function(value) {
                        if (value == "1") {
                            return "个人";
                        }
                        if (value == "2") {
                            return "机构";
                        }else{
                            return value;
                        }
                    }
                },{
                    title : '客户名称',
                    field : 'aipdCustomerName',
                    width : 90,
                    halign : 'center',
                    align : 'center'
                },{
                    title : '证件类型',
                    field : 'aipdCertificateType',
                    width : 90,
                    halign : 'center',
                    align : 'center'
                },{
                    title : '证件号码',
                    field : 'aipdCertificateNo',
                    width : 120,
                    halign : 'center',
                    align : 'center',
                    formatter : function(value) {
                        return value.replace(/^(.{2})(?:\w+)(.{1})$/, "$1****$2");;
                    }
                },{
                    title : '受益级别',
                    field : 'aipdBenefitLevel',
                    width : 90,
                    halign : 'center',
                    align : 'center'
                },{
                    title : '缴款日期',
                    field : 'aipdPaymentDate',
                    width : 90,
                    halign : 'center',
                    align : 'center'
                },{
                    title : '证件有效始',
                    field : 'aipdCertificateStartTime',
                    width : 150,
                    halign : 'center',
                    align : 'center'
                },{
                    title : '证件有效终',
                    field : 'aipdCertificateEndTime',
                    width : 150,
                    halign : 'center',
                    align : 'center'
                },{
                    title : '国籍',
                    field : 'aipdCountry',
                    width : 90,
                    halign : 'center',
                    align : 'center'
                },{
                    title : '上传日期',
                    field : 'aipdUploadTime',
                    width : 150,
                    halign : 'center',
                    align : 'center'
                },{
                    title : '下载日期',
                    field : 'aipdDownloadTime',
                    width : 150,
                    halign : 'center',
                    align : 'center'
                } ] ],
                toolbar : '#toolbar',
                onLoadSuccess: function (data) {
                }
            });
    })

    //查询
    function searchFun() {
        var parmFilter = $.serializeObject($('#searchForm'));
        dataGrid.datagrid('load', parmFilter);
    }
    //下载 （先去查询当前条件下是否有数据）
    function downloadFile() {
        var dUrl = "${ctx}/downloadFile/downloadExcelByChannel";
        var channelCode = $('#selectChannelCode').combobox("getValue");
        var productCode = $('#selectProductCode').combobox("getValue");
        var type = $('#selectType').combobox("getValue");
        var fd = new FormData();
        if (type === null || type == ""){
            $.messager.alert('提示','请选择文件下载的类型 个人OR渠道','warning');
            return;
        }
        $("#disType").val(type);
        if (channelCode != null || channelCode != ""){
            $("#disChannelCode").val(channelCode);
        }
        if (productCode == null || productCode == ""){
            $("#disProductCode").val(productCode);
        }
        fd.append("type", type+"");
        fd.append("channelCode", channelCode+"");
        fd.append("productCode", productCode+"");

        $.ajax({
            url:"${ctx}/downloadFile/checkData",
            type:"post",
            data:fd,
            cache: false,
            processData: false,
            contentType: false,
            success:function(data){
                var resMsg = JSON.parse(data).msg
                if("success" == resMsg){
                    $("#downloadExcel").attr("action",dUrl);
                    $("#downloadExcel").submit();
                }else{
                    $.messager.alert('提示', resMsg,'error');
                }
            },
            error:function(e){
                $.messager.alert("错误","服务器异常，请稍后重试！！！<br/>"+e.message,'error');
            }
        });
    }

</script>
<body class="easyui-layout" data-options="fit:true,border:false">
    <div data-options="region:'north',border:false,title:'操作文件区域'"
		align="center" style="height: 200px;">
        <table>
            <tr>
                <td>
                    渠道:
                    <input class="easyui-combobox"  style = "width:200px;" id="channelCode" name ="filter_channelCode" data-options="
					     url:'${ctx}/combobox/queryChannelInfo',
					     valueField:'ID',
					     textField:'NAME',
					     validType:'length[1,50]',
					     events:{keyup:function(){this.value=this.value.replace(/[^\w]/ig,'')}},"/>
                </td>
                <td>
                    <table style="margin-right: 125px;margin-left: 125px">
                        <tr><td>个人反洗钱信息</td></tr>
                        <tr><td><input class="easyui-filebox" id="file1" style="width:200px" data-options="buttonText:'选择文件', accept:'application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' "/>
                        </td></tr>
                        <tr><td>
                            <a href="javascript:void(0);" class="easyui-linkbutton"	data-options="iconCls:'icon-hamburg-up',plain:true" id="uploadFile1">上传</a>
                            <a href="${ctx}/downloadFile/downloadExcelTemplate?type=1" style="font-size: 13px">模板下载</a></td></tr>
                    </table>
                </td>
                <td>
                    <table>
                        <tr><td>机构反洗钱信息</td></tr>
                        <tr><td><input class="easyui-filebox" id="file2" style="width:200px" data-options="buttonText:'选择文件', accept:'application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' "/>
                        </td></tr>
                        <tr><td>
                            <a href="javascript:void(0);" class="easyui-linkbutton"	data-options="iconCls:'icon-hamburg-up',plain:true" id="uploadFile2">上传</a>
                            <a href="${ctx}/downloadFile/downloadExcelTemplate?type=2" style="font-size: 13px">模板下载</a></td></tr>
                    </table>
                </td>
            </tr>
            <tr><td colspan="10">
                <form id="searchForm">
                    <table align="center">
                        <tr>
                            <th>渠道名称:</th>
                            <td>
                                <input class="easyui-combobox"  style = "width:200px;" id="selectChannelCode" name ="filter_ciChannelCode" data-options="
					     url:'${ctx}/combobox/queryChannelInfo',
					     valueField:'ID',
					     textField:'NAME',
					     validType:'length[1,50]',
					     events:{keyup:function(){this.value=this.value.replace(/[^\w]/ig,'')}},"/>
                            </td>
                            <th>产品名称</th>
                            <td><input class="easyui-combobox"  style = "width:250px;"   id="selectProductCode"   name ="filter_ciProductCode" value = "" data-options="
					     url:'${ctx}/combobox/queryUsedProductInfoComBox',
					     onBeforeLoad:function(param){
					        param.channelCode = '';
					     },
					     valueField:'ID',
					     textField:'NAME',
					     validType:'length[1,50]',
					     events:{keyup:function(){this.value=this.value.replace(/[^\w]/ig,'')}}"/></td>
                            <th>数据类型</th>
                            <td><select id="selectType" name="filter_ciType" style="width: 150px"
                                        class="easyui-combobox">
                                <option value=''>请选择</option>
                                <option value='1'>个人</option>
                                <option value='2'>机构</option>
                            </select></td>
                        </tr>
                        <tr><td colspan="5" align="center">
                            <a href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'icon-search',plain:true" onclick="searchFun();">查询</a>
                            <a href="javascript:void(0);" class="easyui-linkbutton" data-options="iconCls:'icon-hamburg-down',plain:true" onclick="downloadFile();">下载</a>
                        </td></tr>
                    </table>
                </form>
                <form name="downloadFrame" id="downloadExcel" style="display: none;" frameborder="0">
                    <input type="text" id="disChannelCode" name="channelCode">
                    <input type="text" id="disProductCode" name="productCode">
                    <input type="text" id="disType" name="type">
                </form>
            </td></tr>
        </table>
    </div>
    <div data-options="region:'center',border:true,title:'数据展示'" >
        <table id="dataGrid" data-options="fit:true,border:false"></table>
    </div>
    </div>
    <div id="toolbar" style="display: none;">
    </div>
</body>
</html>