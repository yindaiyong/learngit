--货币类对账丰利B、D红宝石七天后置校验
select count(*) from ( 
    select T2.RC_AVAILABLE_VOL-T5.erc_confirmed_vol countflag,T5.rc_FUND_code
            from  D_FUND_ACCOUNT_RECON_CFM T2,
            ( select * from ( select NVL(p1.erc_confirmed_vol,0)+ NVL(p3.erc_confirmed_vol,0) - NVL(p2.erc_confirmed_vol,0) + NVL(P4.RC_AVAILABLE_VOL,0)  erc_confirmed_vol ,
                  p4.rc_channel_code,   --122                     分红143                       124                           上一日对账
                          p4.rc_transaction_account_id,
                          p4.rc_fund_code
             from (
                 select a.rc_available_vol,
                        a.rc_transaction_account_id,
                        a.rc_fund_code,
                        a.rc_channel_code
                       from d_fund_account_recon_cfm a,p_product_info p
                                    where a.rc_fund_code = p.pi_channel_product_code
                          and a.rc_channel_code = p.pi_channel_code
                        and p.pi_product_type in ('1', '2' ,'3')
                        and p.pi_valid_flag = '01'
                        and a.rc_channel_code = 'TTTNETB3'--CHANNELCODE
                        and a.rc_trans_date = '20200521'--LASTDATE
                 )p4 left join --上一个工作日的对账数据                 
                 (select sum(c.erc_confirmed_vol) erc_confirmed_vol,
                          c.erc_channel_code,
                          c.erc_transaction_account_id,
                          c.erc_fund_code
                           from d_exchange_req_cfm c
                          where c.erc_business_code = '022'
                          and c.erc_channel_code='TTTNETB3'--CHANNELCODE
                          and c.erc_return_code='0000'
                          and to_date(c.erc_transaction_cfm_date,'yyyyMMdd') =to_date('20200522','yyyyMMdd')--TRANSDATE
                          group by c.erc_channel_code,
                             c.erc_transaction_account_id,
                             c.erc_fund_code) p1 --当日单个产品单个账户的122确认数据的和               
                ON P1.erc_channel_code = p4.rc_channel_code
                AND p1.erc_transaction_account_id  = p4.rc_transaction_account_id
                AND p1.erc_fund_code = p4.rc_fund_code             
             left join (select nvl(sum(c.erc_confirmed_vol), 0) erc_confirmed_vol,
                               c.erc_channel_code,
                               c.erc_transaction_account_id,
                               c.erc_fund_code
                          from d_exchange_req_cfm c
                         where c.erc_business_code = '024'
                         and c.erc_channel_code='TTTNETB3'--CHANNELCODE
                         and c.erc_return_code='0000'
                         and to_date(c.erc_transaction_cfm_date,'yyyyMMdd') =to_date('20200522','yyyyMMdd')--TRANSDATE
                         group by c.erc_channel_code,
                                  c.erc_transaction_account_id,
                                  c.erc_fund_code) p2--当日单个产品单个账户的124确认数据的和               
               on p4.rc_channel_code = p2.erc_channel_code
              and p4.rc_transaction_account_id = p2.erc_transaction_account_id
              and p4.rc_fund_code = p2.erc_fund_code
                    left join (select nvl(sum(c.dc_dividend_amount), 0) erc_confirmed_vol,
                   c.dc_channel_code,
                   c.dc_transaction_account_id,
                   c.dc_fund_code
              from d_fund_dividend_cfm c
             where  c.dc_channel_code='TTTNETB3'--CHANNELCODE
             and to_date(c.dc_trans_date,'yyyyMMdd')=to_date('20200522','yyyyMMdd')--TRANSDATE
             group by c.dc_channel_code,
                      c.dc_transaction_account_id,
                      c.dc_fund_code) p3 ----当日单个产品单个账户的分红数据值的和             
             on p4.rc_channel_code = p3.dc_channel_code
            and p4.rc_transaction_account_id = p3.dc_transaction_account_id
            and p4.rc_fund_code = p3.dc_fund_code 
          ) T1
        union 
        select t3.erc_confirmed_vol,t3.erc_channel_code,t3.erc_transaction_account_id,t3.erc_fund_code  from ( select sum(t.      erc_confirmed_vol) erc_confirmed_vol,
                          t.erc_channel_code,
                          t.erc_transaction_account_id,
                          t.erc_fund_code 
                from 
                (select c.*　from d_exchange_req_cfm c
                where c.erc_business_code = '022'
                          and c.erc_channel_code='TTTNETB3'--CHANNELCODE
                          and c.erc_return_code='0000'
                          and (select p.pi_product_type from p_product_info p where p.pi_channel_code = c.erc_channel_code and p.pi_channel_product_code = c.erc_fund_code and p.pi_valid_flag not in ('00','99')) in ('1','2','3')
                          and to_date(c.erc_transaction_cfm_date,'yyyyMMdd') =to_date('20200522','yyyyMMdd')--TRANSDATE
                          
                minus
                select c.* from d_exchange_req_cfm c, d_fund_account_recon_cfm a
                where c.erc_channel_code = a.rc_channel_code
                and c.erc_fund_code = a.rc_fund_code
                and c.erc_transaction_account_id = a.rc_transaction_account_id 
                and a.rc_trans_date = '20200521'--LASTDATE
                and c.erc_business_code = '022'
                and (select p.pi_product_type from p_product_info p where p.pi_channel_code = c.erc_channel_code and p.pi_channel_product_code = c.erc_fund_code and p.pi_valid_flag not in ('00','99')) in ('1','2','3')
                and c.erc_channel_code='TTTNETB3'
                and c.erc_return_code='0000'
                and to_date(c.erc_transaction_cfm_date,'yyyyMMdd') =to_date('20200522','yyyyMMdd')--TRANSDATE
               )t--迁移数据加了这段逻辑
               group by t.erc_channel_code,
                             t.erc_transaction_account_id,
                             t.erc_fund_code 
          ) t3   
      )t5
      where T2.rc_channel_code = T5.rc_channel_code
       and T2.rc_transaction_account_id = T5.rc_transaction_account_id
       and T2.rc_fund_code = T5.rc_fund_code
       and T2.rc_channel_code='TTTNETB3'--CHANNELCODE
       and T2.rc_trans_date='20200522'--TRANSDATE
) pp where pp.countflag != 0 
