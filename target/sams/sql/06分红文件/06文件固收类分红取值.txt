--06固收类分红取值
select * from (
select tt.f_repaycapital REPAYCAPITAL,
               tt.f_profit PROFIT,
               tt.f_subinterest SUBINTEREST,
               tt.f_interest INTEREST,
               'SHTP' || tt.L_SERIALNO AS TASERIALNO,
               tt.F_CURBENEFITSHARES,
               nvl(tt.F_PROFIT, 0.00) + nvl(tt.F_SUBINTEREST, 0.00) +
               nvl(tt.F_INTEREST, 0.00) DIVIDENDAMOUNT,
               nvl(tt.F_PROFIT, 0.00) + nvl(tt.F_SUBINTEREST, 0.00) +
               nvl(tt.F_INTEREST, 0.00) CONFIRMEDAMOUNT,
               nvl(tt.F_CURBENEFITSHARES, 0.00) BASISFORCALCULATINGDIVIDEND,
               T2.dci_in_contract || '20190906' AS REQUESTNO,
               '20200520' DOPDATE,--TRANSDATE
               T2.dci_in_contract INCONTRACT,
               T2.dci_fund_code,
          T2.DCI_PRODUCT_CODE TAFUNDCODE,
               '' CHARGE,
               '' AGENCYFEE,
               '' TRANSFERFEE,
               '' SHARECLASS,
               '' DRAWBONUSUNIT,
               '' DIVIDENDTYPE,
               '' ACHIEVEMENTPAY,
               '' ACHIEVEMENTCOMPEN, 
               '' NAV,
               '' BUSINESSCODE,
               '' DIVIDENDPERUNIT,
               '1' DEFDIVIDENDMETHOD,
               '' DEPOSITACCT,
               '' REGIONCODE,
               '' TOTALFROZENVOL,
               '' OTHERFEE1,
               '' OTHERFEE2,
               '' INDIVIDUALORINSTITUTION,
               '' DIVIDENDRATIO,
               '' STAMPDUTY,
               '' FROZENBALANCE,
               '' FEECALCULATOR,
               '' FROZENSHARESFORREINVEST,
               '' ORIGINALAPPSHEETNO,
               (select p.PI_CURRENCY_TYPE
                  from p_product_info p, p_channel_product c
                 where p.pi_channel_product_code = c.cp_channel_product_code
                   and p.pi_channel_code = c.cp_channel_code
                   and c.cp_channel_code = T2.dci_channel_code
                   and c.cp_valid_flag = '01'
                   and c.cp_check_state = '01'
                   and p.pi_valid_flag not in ('00', '99')
                   and p.pi_check_state = '01'
                   and c.cp_channel_product_code = T2.dci_fund_code
                   and c.cp_ta_product_code = T2.DCI_PRODUCT_CODE) CURRENCYTYPE,
           '' VOLOFDIVIDENDFORREINVESTMENT,
           '20200520' TRANSACTIONCFMDATE,--TRANSDATE
           '20200520' DIVIDENTDATE,--TRANSDATE
           '20200520' XRDATE,--TRANSDATE
           '20200520' REGISTRATIONDATE,--TRANSDATE
           '20200520' DOWNLOADDATE,--TRANSDATE
           T2.dci_fund_code FUNDCODE,
           T2.dci_channel_code CHANNELCODE,
           '20200519' LASTDATE,--LASTDATE
           '0000' RETURNCODE, 
         T2.DCI_TRANS_ACTION_ACCOUNT    TRANSACTIONACCOUNTID,
         T2.DCI_TA_ACCOUNT_ID    TAACCOUNTID,
         T2.DCI_DISTRIBUTOR_CODE    DISTRIBUTORCODE,
         T2.DCI_BRANCH_CODE    BRANCHCODE,
         T2.DCI_PRODUCT_CODE
  from  
     (select * 
     from ta_tprofitdealcurrentdetails t
    where  exists
 (select 1
          from ta_tbusinremitmcurrents t2, ta_tremitmoneydetail t3
         where t2.l_businserialno = t.l_serialno
            and TO_CHAR(t3.d_expectdate, 'YYYYMMDD') >= '20200519'--LASTDATE
            and TO_CHAR(t3.d_expectdate, 'YYYYMMDD') < '20200520'--TRANSDATE
            and t2.l_remitserialno = t3.l_firstserialno
            -- created by 王超 20200427 加入划款成功的标志条件，防止划款失败的数据也被取出 -->
            and t3.c_status <> '4')
     )TT,  d_contract_info  T2
  where TT.l_contractserialno = T2.DCI_IN_CONTRACT
  and tt.c_fundacco = t2.dci_ta_account_id
  and T2.DCI_CHANNEL_CODE = 'TTTNETRFYH') jj--CHANNELCODE
   where exists (select 1
                      from (
                      --create by yindy 函数修改  -->
                      select distinct c.CP_TA_PRODUCT_CODE fundcode
                      ,p.pi_channel_product_code 
                from p_product_info p, p_channel_product c
               where p.pi_channel_product_code = c.cp_channel_product_code
                 and p.pi_channel_code=c.cp_channel_code
                 and c.cp_channel_code = 'TTTNETRFYH'--CHANNELCODE
                 and c.cp_valid_flag = '01'
                 and c.cp_check_state = '01'
                 and p.pi_valid_flag not in('00','99')
               and p.pi_check_state = '01'
               and p.pi_product_type='4'-- PRODUCTTYPE
                      -- 修改结束 -->
                      ) temp
                     where temp.fundcode = jj.DCI_PRODUCT_CODE
                     and jj.dci_fund_code = temp.pi_channel_product_code)
  -- 分红确认金额为0,不取出来 -->                  
  and nvl(jj.dividendamount,0) != 0  
  
  -- 20200331 过滤掉部分返本的分红 -->
  and not exists (
    select n.dci_fund_code,
         n.dci_in_contract,
         n.dci_out_contract,
         n.dci_trans_action_account,
         n.dci_ta_account_id,
         n.dci_product_code
      from d_exchange_req_cfm t, d_contract_info n
       where t.erc_channel_code = n.dci_channel_code
       and t.erc_app_sheet_serial_no = n.dci_app_sheet_serial_no
       and t.erc_transaction_account_id = n.dci_trans_action_account
       and t.erc_fund_code = n.dci_fund_code
       and t.erc_return_code = '0000'
       and t.erc_business_code = '150'
       and n.dci_valid_flag = '01'
       and t.erc_trans_date = '20200520'
       and t.erc_channel_code = 'TTTNETRFYH'--CHANNELCODE
       and exists (
        select 1 from tj_contractdetails t where  t.c_fundcode =n.dci_product_code
              and t.l_contractserialno = n.dci_in_contract
              and t.c_trustcontractid = n.dci_out_contract
              and t.c_fundacco = n.dci_ta_account_id
              and t.f_remainshares_sams != 0
       )
       and n.dci_in_contract = jj.INCONTRACT
         and n.dci_trans_action_account = jj.TRANSACTIONACCOUNTID
         and n.dci_ta_account_id = jj.TAACCOUNTID
         and n.dci_product_code = jj.DCI_PRODUCT_CODE
         and n.dci_fund_code = jj.dci_fund_code
  )  