<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sams.custom.mapper.CloseDateMapper" >
  <resultMap id="BaseResultMap" type="com.sams.custom.model.CloseDate" >
    <id column="CD_ID" property="cdId" jdbcType="DECIMAL" />
    <result column="CD_MARKET_CODE" property="cdMarketCode" jdbcType="VARCHAR" />
    <result column="CD_YEAR" property="cdYear" jdbcType="VARCHAR" /> 
    <result column="CD_MONTH" property="cdMonth" jdbcType="VARCHAR" />
    <result column="CD_CLOSE_DATE" property="cdCloseDate" jdbcType="VARCHAR" />
    <result column="CD_CHECK_STATE" property="cdCheckState" jdbcType="VARCHAR" />
    <result column="CD_CTIME" property="cdCtime" jdbcType="TIMESTAMP" />
    <result column="CD_UTIME" property="cdUtime" jdbcType="TIMESTAMP" />
    <result column="CD_CUSER" property="cdCuser" jdbcType="VARCHAR" />
    <result column="CD_UUSER" property="cdUuser" jdbcType="VARCHAR" />
     <result column="CD_ACTION" property="cdAction" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    CD_ID, CD_MARKET_CODE, CD_YEAR, CD_MONTH, CD_CLOSE_DATE, CD_CHECK_STATE, CD_CTIME, 
    CD_UTIME, CD_CUSER, CD_UUSER,CD_ACTION
  </sql>
  <select id="selectByMarketCodeAndcdCloseDate" resultType="java.lang.Integer"  parameterType="com.sams.custom.model.CloseDate" >
    select count(1)
     from P_CLOSE_DATE t where 1=1 
     and t.cd_check_state='01'
     <if test="cdMarketCode != null" >
    	and t.cd_market_code=#{cdMarketCode,jdbcType=VARCHAR}
    </if>
    <if test="cdCloseDate != null" >
    	and t.cd_close_date=#{cdCloseDate,jdbcType=VARCHAR}
    </if>
  </select>
  
    <select id="findCloseDateCondition" parameterType="java.util.Map"  resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        FROM p_close_date where 1=1
        <if test=" condition.cdMarketCode != null and condition.cdMarketCode != ''  ">
                and CD_MARKET_CODE =  #{condition.cdMarketCode} 
        </if>
        <if test=" condition.cdYear != null and condition.cdYear != ''  ">
                and CD_YEAR =  #{condition.cdYear} 
        </if>
        <if test=" condition.cdMonth != null and condition.cdMonth != '' ">
                and CD_MONTH = #{condition.cdMonth} 
        </if>
        <if test=" condition.cdCheckState != null and condition.cdCheckState != '' ">
                and CD_CHECK_STATE = #{condition.cdCheckState} 
        </if>
    </select>
    
    <select id="findClodeDateByCodeDate" parameterType="java.util.Map"  resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        FROM p_close_date where 1=1
        <if test="cdMarketCode != null and cdMarketCode != ''  ">
                and CD_MARKET_CODE =  #{cdMarketCode,jdbcType=VARCHAR} 
        </if>
        <if test="cdYear!= null and cdYear != ''  ">
                and CD_YEAR =  #{cdYear,jdbcType=VARCHAR} 
        </if>
        <if test="cdMonth != null and cdMonth!= '' ">
                and CD_MONTH = #{cdMonth,jdbcType=VARCHAR} 
        </if>
    </select>
    
   <insert id="insert" parameterType="com.sams.custom.model.CloseDate" >
    insert into P_CLOSE_DATE (CD_ID, CD_MARKET_CODE, CD_YEAR, 
      CD_MONTH, CD_CLOSE_DATE, CD_CHECK_STATE, 
      CD_CTIME, CD_UTIME, CD_CUSER, 
      CD_UUSER,CD_ACTION)
    values (#{cdId,jdbcType=DECIMAL}, #{cdMarketCode,jdbcType=VARCHAR}, #{cdYear,jdbcType=VARCHAR}, 
      #{cdMonth,jdbcType=VARCHAR}, #{cdCloseDate,jdbcType=VARCHAR}, #{cdCheckState,jdbcType=VARCHAR}, 
      #{cdCtime,jdbcType=TIMESTAMP}, #{cdUtime,jdbcType=TIMESTAMP}, #{cdCuser,jdbcType=VARCHAR}, 
      #{cdUuser,jdbcType=VARCHAR},#{cdAction,jdbcType=VARCHAR})
  </insert>
  <update id="updateByPrimaryKey" parameterType="java.util.List">
      <foreach collection="list" item="item" index="index" open="begin" close=";end;" separator=";">
    update P_CLOSE_DATE
    set 
      CD_CHECK_STATE = #{item.cdCheckState,jdbcType=VARCHAR},
      CD_UTIME = #{item.cdUtime,jdbcType=TIMESTAMP},
      CD_UUSER = #{item.cdUuser,jdbcType=VARCHAR},
      CD_ACTION = #{item.cdAction,jdbcType=VARCHAR}
    where 
    CD_MARKET_CODE = #{item.cdMarketCode,jdbcType=VARCHAR}
    and   CD_YEAR = #{item.cdYear,jdbcType=VARCHAR}
    and   CD_MONTH = #{item.cdMonth,jdbcType=VARCHAR}
    </foreach>
  </update>
  
  <delete id="deleteCloseDate" parameterType="hashMap" >
    delete from P_CLOSE_DATE
    where 1=1
    <if test="YEAR != null" >
      AND  CD_YEAR=#{YEAR,jdbcType=VARCHAR}
    </if>
    <if test="MONTH != null" >
      AND  CD_MONTH=#{MONTH,jdbcType=VARCHAR}
    </if>
     <if test="MARKETCODE != null" >
      AND  CD_MARKET_CODE=#{MARKETCODE,jdbcType=VARCHAR}
    </if>
  </delete>
    <select id="selectMonList" resultMap="BaseResultMap">
        select t1.*
        from p_close_date t1,
        (select cd_month c_month, max(cd_close_date) c_close_date
        from p_close_date
        where 1=1
        <if test="YEAR != null" >
            AND  CD_YEAR=#{YEAR,jdbcType=VARCHAR}
        </if>
        <if test="MARKETCODE != null" >
            AND  CD_MARKET_CODE=#{MARKETCODE,jdbcType=VARCHAR}
        </if>
        group by cd_month) t2
        where t1.cd_close_date = t2.c_close_date
        and t1.cd_month = t2.c_month
        <if test="YEAR != null" >
            AND  t1.CD_YEAR=#{YEAR,jdbcType=VARCHAR}
        </if>
        <if test="MARKETCODE != null" >
            AND  t1.CD_MARKET_CODE=#{MARKETCODE,jdbcType=VARCHAR}
        </if>
    </select>
    <!--根据条件更新每月的非工作日配置数据 -->
    <update id="updateStatusByMonthIndex" parameterType="hashmap">
        update p_close_date
        <set>
            <if test="userName != null">
                CD_UUSER = #{userName,jdbcType=VARCHAR},
            </if>
            <if test="action != null">
                CD_ACTION = #{action,jdbcType=VARCHAR},
            </if>
            <if test="checkStatus != null">
                CD_CHECK_STATE = #{checkStatus,jdbcType=VARCHAR},
            </if>
        </set>
        where
        <choose>
            <when test="marketVal != null and yearVal != null and mon != null">
              1 = 1
            </when>
            <otherwise>
              1 != 1
            </otherwise>
        </choose>
        <if test="marketVal != null">
            AND  CD_MARKET_CODE=#{marketVal,jdbcType=VARCHAR}
        </if>
        <if test="yearVal != null">
            AND  CD_YEAR=#{yearVal,jdbcType=VARCHAR}
        </if>
        <if test="mon != null">
            AND  cd_month=#{mon,jdbcType=VARCHAR}
        </if>
    </update>
    <!--根据实体类删除操作-->
    <delete id="deleteCloseDateByDate" parameterType="com.sams.custom.model.CloseDate">
        delete from P_CLOSE_DATE
        where
        <choose>
            <when test="cdMarketCode != null and cdCloseDate != null">
                1 = 1
            </when>
            <otherwise>
                1 != 1
            </otherwise>
        </choose>
        and CD_MARKET_CODE = #{cdMarketCode,jdbcType=VARCHAR}
        and   CD_YEAR = #{cdYear,jdbcType=VARCHAR}
        and   CD_MONTH = #{cdMonth,jdbcType=VARCHAR}
        and   cd_close_date = #{cdCloseDate,jdbcType=VARCHAR}
    </delete>

    <insert id="insertByBatch">
        insert
        <foreach collection="list" index="index" item="item" open="All" close="SELECT 1 FROM DUAL">
        into P_CLOSE_DATE (CD_ID, CD_MARKET_CODE, CD_YEAR,
    CD_MONTH, CD_CLOSE_DATE, CD_CHECK_STATE,
    CD_CTIME, CD_UTIME, CD_CUSER,
    CD_UUSER,CD_ACTION)
        values
     (#{item.cdId,jdbcType=DECIMAL}, #{item.cdMarketCode,jdbcType=VARCHAR}, #{item.cdYear,jdbcType=VARCHAR},
    #{item.cdMonth,jdbcType=VARCHAR}, #{item.cdCloseDate,jdbcType=VARCHAR}, #{item.cdCheckState,jdbcType=VARCHAR},
    #{item.cdCtime,jdbcType=TIMESTAMP}, #{item.cdUtime,jdbcType=TIMESTAMP}, #{item.cdCuser,jdbcType=VARCHAR},
    #{item.cdUuser,jdbcType=VARCHAR},#{item.cdAction,jdbcType=VARCHAR})
    </foreach>
    </insert>

</mapper>