<template>
    <layout-page-default :focusPageIndex=3>
        <div class="page-sample-analysis">
            <div class="wrap">
                <el-row>
                    <el-col :span="12">
                        <div class="module">
                            <div class="title">样本分析条件选择</div>
                            <div class="condition">
                                <div class="search">
                                    <el-form :inline="true" :model="analyzeConditionForm" :rules="analyzeConditionFormRules" ref="analyzeConditionForm" size="mini">
                                        <el-form-item label="期次" prop="periodCode">
                                            <el-select v-model="analyzeConditionForm.periodCode" clearable @change="changeConditionPeriod()" @focus="focusConditionPeriod()">
                                                <el-option
                                                    v-for="item in conditionPeriods"
                                                    :key="item.id"
                                                    :label="item.name"
                                                    :value="item.id">
                                                </el-option>
                                            </el-select>
                                        </el-form-item>
                                        <el-form-item label="样本名称" style="margin-left:20px;" prop="sampleCode">
                                            <el-select v-model="analyzeConditionForm.sampleCode" filterable clearable placeholder="输入或选择">
                                                <el-option
                                                    v-for="item in conditionSampleCodes"
                                                    :key="item.id"
                                                    :label="item.name"
                                                    :value="item.id">
                                                </el-option>
                                            </el-select>
                                        </el-form-item>
                                    </el-form>
                                </div>
                                <div class="option">
                                    <el-button type="primary" icon="el-icon-search" size="small" @click="getTreeOfSampleAnalyse('analyzeConditionForm')">获取报表列表</el-button>
                                    <el-link href="/analysisReport"  class="link">跳转灵活报表分析</el-link>
                                    <el-link href="/dataSampling"  class="link">返回数据抽样</el-link>
                                </div>
                                <div class="tree">
                                    <el-scrollbar style="height:100%">
                                        <el-tree
                                            :data="treeDatas"
                                            show-checkbox
                                            node-key="id"
                                            default-expand-all
                                            :default-checked-keys="treeCheckedKeys"
                                            :props="treeProps"
                                            @check-change="handleCheckChange">
                                        </el-tree>
                                    </el-scrollbar>
                                </div>
                                <div>
                                    <el-button type="primary" size="mini" style="float:right;" @click="doSampleAnalyze()">发起样本分析</el-button>
                                </div>
                            </div>
                        </div>
                    </el-col>
                    <el-col :span="12">
                        <div class="module">
                            <div class="title">样本分析结果列表</div>
                            <div class="result">
                                <div class="search">
                                    <el-form :inline="true" :model="analyzeResultForm" size="mini">
                                        <el-form-item label="期  次" :label-width="resultLabelWidth">
                                            <el-select v-model="analyzeResultForm.periodCode" clearable @change="changeResultPeriod()" @focus="focusResultPeriod()">
                                                <el-option
                                                    v-for="item in resultPeriods"
                                                    :key="item.id"
                                                    :label="item.name"
                                                    :value="item.id">
                                                </el-option>
                                            </el-select>
                                        </el-form-item>
                                        <el-form-item label="样本名称" :label-width="resultLabelWidth" style="margin-left:20px;">
                                            <el-select v-model="analyzeResultForm.sampleCode" filterable clearable placeholder="输入或选择">
                                                <el-option
                                                    v-for="item in resultSampleCodes"
                                                    :key="item.id"
                                                    :label="item.name"
                                                    :value="item.id">
                                                </el-option>
                                            </el-select>
                                        </el-form-item>
                                        <el-form-item label="报表名称" :label-width="resultLabelWidth">
                                            <el-input v-model="analyzeResultForm.sampleReportName" autocomplete="off"></el-input>
                                        </el-form-item>
                                        <div class="option">
                                            <el-button type="primary" icon="el-icon-search" size="small" @click="searchSampleAnalyzeResult()">查询</el-button>
                                            <el-button type="primary" icon="el-icon-download" size="small" @click="exportSampleAnalyze()" class="export">导出</el-button>
                                        </div>
                                    </el-form>
                                </div>
                                <el-table :data="resultData" border size="mini" height="380" @selection-change="MultiSelectionChange">
                                    <el-table-column type="selection" :selectable='canDownload' width="40"></el-table-column>
                                    <el-table-column show-overflow-tooltip prop="sampleName" align="center" width = "220" label="样本名称"></el-table-column>
                                    <el-table-column show-overflow-tooltip prop="sampleReportName" align="center" width = "120" label="报表名称"></el-table-column>
                                    <el-table-column show-overflow-tooltip align="center" label="操作" width="100">
                                        <template slot-scope="scope">
                                            <el-button size="mini" type="primary" class="el-icon-refresh-right" v-if="scope.row.reportStatus === '2'" @click="preview(scope.row)">预览</el-button>
                                        </template>
                                    </el-table-column>
                                    <el-table-column show-overflow-tooltip prop="reportStatus" align="center" width = "100" label="生成状态">
                                        <template slot-scope="scope">
                                            <span v-if="scope.row.reportStatus === '1'" style="color: #9A9FFF">生成中</span>
                                            <span v-if="scope.row.reportStatus === '2'" style="color: #9BC454">生成成功</span>
                                            <span v-if="scope.row.reportStatus === '9'" style="color: red">生成失败</span>
                                        </template>
                                    </el-table-column>
                                    <el-table-column show-overflow-tooltip prop="remarks" align="center" width = "150" label="错误描述"></el-table-column>
                                </el-table>
                                <el-pagination
                                    background
                                    layout="total, sizes, prev, pager, next, jumper"
                                    align="center"
                                    :page-sizes="[10, 20, 30, 50]"
                                    :total="resultTotal"
                                    :page-size="resultPageSize"
                                    :current-page="resultCurrentPage"
                                    @current-change="handleCurrentChange"
                                    @size-change="handleSizeChange"
                                ></el-pagination>
                            </div>
                        </div>
                    </el-col>
                </el-row>
            </div>
        </div>
    </layout-page-default>
</template>

<script>
import LayoutPageDefault from "layout/LayoutPageDefault.vue";

export default {
    components: {
        LayoutPageDefault
    },
    data() {
        return {
            //分析条件
            analyzeConditionForm: {
                periodCode: "",
                sampleCode: "",
            },
            analyzeConditionFormRules: {
                periodCode: [
                    { required: true, message: '请选择期次号', trigger: 'change' }
                ],
                sampleCode: [
                    { required: true, message: '请输入或选择样本名称', trigger: 'change' }
                ]
            },
            conditionPeriods:[],
            conditionSampleCodes:[],
            //tree
            treeDatas: [],
            treeCheckedKeys: [],
            treeProps: {
                children: 'children',
                label: 'label',
                id :'id'
            },
            treeSelectedData :[],
            //分析结果
            resultLabelWidth: '70px',
            analyzeResultForm: {
                periodCode: "",
                sampleCode: "",
                sampleReportName: ""
            },
            resultPeriods:[],
            resultSampleCodes:[],

            resultData: [],
            resultTotal: 0,
            resultPageSize: 10,
            resultCurrentPage: 1,
            multipleSelection :[],
        };
    },  
    methods: {
        focusConditionPeriod(){
            this.analyzeConditionForm.periodCode = '';
            let req ={organCode:sessionStorage.getItem('organCode')};
            this.$api.PeriodComboBox(req).then(res => {
                this.conditionPeriods = res.data;
            }).catch(err => {
                this.$commsgbox.alert(err);
            });
        },
        changeConditionPeriod(){
            this.analyzeConditionForm.sampleCode = '';
            let req = {periodCode : this.analyzeConditionForm.periodCode, organCode:sessionStorage.getItem('organCode')};
            this.$api.SampleNameComboBox(req).then(res => {
                this.conditionSampleCodes = res.data;
            }).catch(err => {
                this.$commsgbox.alert(err);
            });
        },
        getTreeOfSampleAnalyse(formName){
            if(!sessionStorage.getItem('organCode')){
                this.$commsgbox.alert("请选择操作机构");
                return false;
            }
            this.$refs[formName].validate((valid) => {
                if (valid) {
                    let req = {
                        organCode : sessionStorage.getItem('organCode'),
                        periodCode: this.analyzeConditionForm.periodCode,
                        sampleCode: this.analyzeConditionForm.sampleCode,
                    };
                    this.$api.TreeOfSampleAnalyse(req).then(res => {
                        this.treeDatas = res.data.treeData;
                        // this.treeCheckedKeys = res.data.checkedKeys;
                    }).catch(err => {
                        this.$commsgbox.alert(err);
                    });
                }
            });
        },
        handleCheckChange(data, checked, indeterminate) {
            if(data.children == undefined){
                if(checked  == true){
                    console.log("勾选" + data, checked, indeterminate);
                    this.treeSelectedData.push(data.id);
                }else{
                    console.log("取消" + data, checked, indeterminate);
                    this.treeSelectedData.pop(data.id);
                }
                console.log(this.treeSelectedData);
            }
        },
        //提交样本分析
        doSampleAnalyze(){
            if(!sessionStorage.getItem('organCode')){
                this.$commsgbox.alert("请选择操作机构");
                return false;
            }
            if(this.treeSelectedData.length == 0){
                this.$commsgbox.alert("请选择要分析的报表类型");
                return false;
            }
            let req = {
                organCode : sessionStorage.getItem('organCode'),
                periodCode : this.analyzeConditionForm.periodCode,
                sampleCode : this.analyzeConditionForm.sampleCode,
                sysFormCodeList : this.treeSelectedData
            };
            this.$api.DoSampleAnalyse(req).then(res => {
      
            }).catch(err => {
                this.$commsgbox.alert(err);
            });
        },
        //样本结果分析
        focusResultPeriod(){
            this.analyzeResultForm.periodCode = '';
            let req ={organCode:sessionStorage.getItem('organCode')};
            this.$api.PeriodComboBox(req).then(res => {
                this.resultPeriods = res.data;
            }).catch(err => {
                this.$commsgbox.alert(err);
            });
        },
        changeResultPeriod(){
            this.analyzeResultForm.sampleCode = '';
            let req = {periodCode : this.analyzeResultForm.periodCode, organCode:sessionStorage.getItem('organCode')};
            this.$api.SampleNameComboBox(req).then(res => {
                this.resultSampleCodes = res.data;
            }).catch(err => {
                this.$commsgbox.alert(err);
            });
        },

        handleCurrentChange(val) {
            this.resultCurrentPage = val;
            // this.getFileUploadRecord();
        },
        handleSizeChange(val) {
            this.resultPageSize = val;
            // this.getFileUploadRecord();
        },
        MultiSelectionChange(val){
            this.multipleSelection = val;
        },
        canDownload(row){
            if(row.reportStatus == '2'){
                return true;
            }else{
                return false;
            }
        }
    },
    created() {
    },
    mounted(){
    }
};
</script>

<style scoped>
.page-sample-analysis .wrap {
    height: 600px; /* TODO delete */
    border:1px solid #ddd;
    border-radius: 20px;
    margin:20px;
}
.page-sample-analysis .wrap .module {
    height: 600px; /* TODO delete */
    width: 90%;
    margin:0 auto;
    border:1px solid #ddd;
    border-top-width: 0px;
    border-radius: 20px;
}
.page-sample-analysis .wrap .module .title{
    height: 50px;
    line-height: 50px;
    text-align: center !important;
    font-size: 28px;
    font-weight: bold;
    color: #fff;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    background-color: #409eff;
}
.page-sample-analysis .wrap .module .condition {
    padding: 20px;
}
.page-sample-analysis .wrap .module .condition .option{
    text-align: left;
}
.page-sample-analysis .wrap .module .condition .option .link{
    color:#409EFF;
    padding:9px 4px;
    float:right;
    margin-left:20px;
    font-size:14px;
}
.page-sample-analysis .wrap .module .condition .tree {
    width:100%;
    margin: 20px 0px;
    border:1px solid #000;
    height:360px;
}
.page-sample-analysis .wrap .module .result {
    padding: 20px;
}
.page-sample-analysis .wrap .module .result .search{
    text-align: left;
}
.page-sample-analysis .wrap .module .result .search .option{
    float: right;
}
.page-sample-analysis .wrap .module .result .search .option .export{
    background-color: #fff;
    color: #555;
    margin-left:30px;
}
</style>
<style>
.page-sample-analysis .wrap .module .result .search .el-form-item__label{
    text-align: center;
}
.page-sample-analysis .wrap .module .result .search .el-input,
.page-sample-analysis .wrap .module .result .search .el-select {
    width: 180px;
}
.page-sample-analysis .el-scrollbar .el-scrollbar__wrap {overflow-x: hidden;}
</style>